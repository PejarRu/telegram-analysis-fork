{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Telegram Analysis API","text":"<p>Bienvenido a la referencia r\u00e1pida del servicio que expone mensajes de Telegram mediante Flask + Telethon.</p>"},{"location":"#caracteristicas-clave","title":"Caracter\u00edsticas clave","text":"<ul> <li>Cliente \u00fanico de Telethon compartido por todos los endpoints.</li> <li>Enriquecimiento de mensajes con enlaces firmados para archivos multimedia.</li> <li>Reenv\u00edo opcional a webhooks (incluido listener en tiempo real).</li> <li>Despliegue simple via Docker + Dokploy/Traefik.</li> </ul>"},{"location":"#requisitos-previos","title":"Requisitos previos","text":"<ol> <li>Crea un archivo <code>.env</code> a partir de <code>.env.example</code> y rell\u00e9nalo con tus credenciales de Telegram y <code>API_KEY</code>.</li> <li>Genera la sesi\u00f3n de Telethon una vez:    <pre><code>python -m app.auth\n</code></pre></li> <li>Monta el archivo de sesi\u00f3n (p. ej. <code>@usuario.session</code>) en <code>data/</code> tanto en local como en producci\u00f3n.</li> </ol>"},{"location":"#ejecutar-en-local","title":"Ejecutar en local","text":"<pre><code>python -m venv .venv\nsource .venv/bin/activate\npip install -r requirements.txt\npython -m app.main\n</code></pre> <p>La API escucha en <code>http://127.0.0.1:5000/</code>.</p>"},{"location":"#ejemplos","title":"Ejemplos","text":"<pre><code>curl -X POST http://127.0.0.1:5000/trigger \\\n  -H 'Content-Type: application/json' \\\n  -H \"X-API-Key: ${API_KEY}\" \\\n  -d '{\"entity\": \"@telegram\", \"limit\": 2}'\n\ncurl \"http://127.0.0.1:5000/message?entity=@telegram&amp;message_id=123\" \\\n  -H \"X-API-Key: ${API_KEY}\"\n</code></pre>"},{"location":"#endpoints-principales","title":"Endpoints principales","text":"M\u00e9todo Ruta Descripci\u00f3n <code>POST</code> <code>/trigger</code> Recupera <code>limit</code> mensajes recientes y opcionalmente los env\u00eda a un webhook. <code>GET</code> <code>/message</code> Devuelve un mensaje concreto por ID manteniendo el formato de <code>/trigger</code>. <code>GET</code> <code>/media/&lt;token&gt;</code> Sirve archivos mediante enlaces firmados (<code>signed_url</code>). <code>GET</code> <code>/last-response</code> Expone el \u00faltimo payload persistido (requiere API key). <code>GET</code> <code>/</code> P\u00e1gina HTML con documentaci\u00f3n y versi\u00f3n del servicio. <p>Todos los endpoints salvo <code>/media/&lt;token&gt;</code> requieren <code>X-API-Key: &lt;API_KEY&gt;</code> o <code>Authorization: Bearer &lt;API_KEY&gt;</code>.</p>"},{"location":"#variables-de-entorno-destacadas","title":"Variables de entorno destacadas","text":"<ul> <li><code>TELEGRAM_API_ID</code>, <code>TELEGRAM_API_HASH</code>, <code>TELEGRAM_PHONE</code>, <code>TELEGRAM_USERNAME</code> \u2014 credenciales b\u00e1sicas.</li> <li><code>TELEGRAM_SESSION_FILE</code>, <code>TELEGRAM_SESSION_DIR</code> \u2014 d\u00f3nde se almacena la sesi\u00f3n (.session) autorizada.</li> <li><code>API_KEY</code> \u2014 clave compartida obligatoria para proteger los endpoints.</li> <li><code>N8N_WEBHOOK_URL</code> \u2014 destino por defecto cuando un payload debe reenviarse.</li> <li><code>TELEGRAM_MEDIA_DIR</code>, <code>MEDIA_BASE_URL</code> \u2014 controlan d\u00f3nde se descargan y exponen los archivos.</li> <li><code>MEDIA_SIGNING_SECRET</code>, <code>MEDIA_URL_TTL_SECONDS</code> \u2014 par\u00e1metros de los enlaces firmados para <code>/media/&lt;token&gt;</code>.</li> <li><code>TELEGRAM_LISTENER_ENTITY</code>, <code>LISTENER_WEBHOOK_URL</code> \u2014 activan el listener en tiempo real.</li> </ul> <p>Consulta <code>app/config.py</code> para ver el listado completo y los valores por defecto.</p>"},{"location":"#despliegue-en-produccion-resumen","title":"Despliegue en producci\u00f3n (resumen)","text":"<ol> <li>Copia el archivo de sesi\u00f3n autorizado al servidor y m\u00f3ntalo en <code>/app/data</code> dentro del contenedor.</li> <li>Configura las variables de entorno en Dokploy (o el orquestador que uses).</li> <li>Despliega usando el Dockerfile incluido. Gunicorn expone el puerto interno <code>8000</code>.</li> <li>Tras el despliegue, valida con:    <pre><code>curl -X POST https://tu-dominio/trigger \\\n  -H 'Content-Type: application/json' \\\n  -H 'X-API-Key: &lt;tu-clave&gt;' \\\n  -d '{\"entity\": \"@telegram\", \"limit\": 1}'\n</code></pre></li> </ol>"},{"location":"#listener-en-tiempo-real","title":"Listener en tiempo real","text":"<p>Define las variables:</p> <pre><code>TELEGRAM_LISTENER_ENTITY=@tu_canal\nLISTENER_WEBHOOK_URL=https://n8n.dominio.com/webhook/telegram-live\n</code></pre> <p>El servicio lanzar\u00e1 un hilo que escucha <code>NewMessage</code>, descarga medios y env\u00eda cada payload al webhook configurado; el \u00faltimo mensaje queda persistido en <code>data/last_response.json</code>.</p>"},{"location":"#inspeccionar-el-ultimo-payload","title":"Inspeccionar el \u00faltimo payload","text":"<pre><code>curl https://tu-dominio/last-response \\\n  -H 'X-API-Key: &lt;tu-clave&gt;'\n</code></pre> <p>Recibir\u00e1s el JSON almacenado o <code>{\"message\": \"No response yet\"}</code> si a\u00fan no existe.</p>"},{"location":"#documentacion-estatica","title":"Documentaci\u00f3n est\u00e1tica","text":"<p>Este sitio se genera con MkDocs Material. Para modificarlo:</p> <pre><code>pip install -r mkdocs-material-deps.txt\nmkdocs serve\n</code></pre> <p>Abre <code>http://127.0.0.1:8000/</code> (el que usa MkDocs) para previsualizar. Cuando est\u00e9s listo publica con <code>mkdocs build</code> o <code>mkdocs gh-deploy</code>.</p>"},{"location":"telegram-republisher-spec/","title":"Telegram Translation + Republisher \u2014 SPEC","text":""},{"location":"telegram-republisher-spec/#rol","title":"Rol","text":"<p>Act\u00faa como ingeniero senior especializado en:</p> <ul> <li>Telegram (MTProto + Bot API)</li> <li>n8n</li> <li>Sistemas de automatizaci\u00f3n con LLMs</li> </ul> <p>Tu tarea no es solo implementar, sino auditar, corregir y mejorar un sistema en producci\u00f3n.</p>"},{"location":"telegram-republisher-spec/#accesos-disponibles","title":"Accesos disponibles","text":"<ul> <li>MCP de n8n (configurado en <code>.vscode/mcp.json</code>)</li> <li>C\u00f3digo local de una API custom basada en Telethon</li> <li>Workflow existente en n8n</li> <li>VPS con la API Telethon desplegada</li> </ul>"},{"location":"telegram-republisher-spec/#datos-del-entorno-fuente-de-verdad","title":"Datos del entorno (fuente de verdad)","text":"<ul> <li>Canal origen: <code>@knyazevinvest</code></li> <li>Canal destino (chat_id): <code>-4673324381</code></li> <li>Dominio API Telethon: <code>https://api-telegram.antonberzins.com</code></li> <li>Auth header: <code>X-API-Key</code> (ya configurado en n8n)</li> <li>Endpoint principal:</li> <li><code>POST /trigger</code></li> <li>Body ejemplo:     <pre><code>{\n  \"entity\": \"@knyazevinvest\",\n  \"limit\": 2\n}\n</code></pre></li> <li>Respuesta esperada:</li> <li>Array de mensajes Telethon</li> <li> <p>Campos relevantes:</p> <ul> <li><code>id</code></li> <li><code>date</code></li> <li><code>message</code> (texto)</li> <li><code>media</code> (si existe)</li> <li><code>grouped_id</code> (si \u00e1lbum)</li> </ul> </li> <li> <p>C\u00f3digo local API Telethon:</p> </li> <li>El usuario indicar\u00e1 la ruta para inspecci\u00f3n directa</li> </ul>"},{"location":"telegram-republisher-spec/#contexto-general","title":"Contexto general","text":"<p>Existe un workflow en n8n llamado:</p> <p>\ud83d\udfe2 Telegram Translation + Republisher</p> <p>El sistema lleva semanas en producci\u00f3n y funciona parcialmente, pero presenta problemas cr\u00edticos de consistencia.</p>"},{"location":"telegram-republisher-spec/#objetivo-del-sistema","title":"Objetivo del sistema","text":"<ul> <li>Leer mensajes de un canal/grupo p\u00fablico usando Telethon (MTProto)</li> <li>Filtrar y traducir contenido informativo al espa\u00f1ol</li> <li>Republicar en un canal propio usando Bot API</li> <li>Eliminar publicidad, promociones y CTAs</li> <li>Mantener fidelidad total al texto original:</li> <li>estructura</li> <li>listas</li> <li>emojis</li> <li>tono</li> <li>Evitar duplicados</li> <li>Idealmente clonar tambi\u00e9n la imagen del post original</li> </ul>"},{"location":"telegram-republisher-spec/#flujo-actual-alto-nivel","title":"Flujo actual (alto nivel)","text":"<ol> <li>Trigger (Schedule / Manual)</li> <li>HTTP Request \u2192 API Telethon (<code>/trigger</code>)</li> <li>Split Out \u2192 1 item = 1 mensaje</li> <li>Set / Mapeado:</li> <li><code>id</code></li> <li><code>text</code></li> <li><code>date</code></li> <li><code>link = https://t.me/&lt;grupo&gt;/&lt;id&gt;</code></li> <li><code>media</code> (si existe)</li> <li>Remove Duplicates (por <code>id</code>)</li> <li>AI Agent:</li> <li>Decide qu\u00e9 hacer con el mensaje</li> <li>Telegram Tool:</li> <li>Env\u00eda texto al canal destino</li> </ol>"},{"location":"telegram-republisher-spec/#validacion-critica-anti-mismatch","title":"Validaci\u00f3n CR\u00cdTICA (anti-mismatch)","text":"<p>Para cada mensaje debe cumplirse:</p> <ul> <li>El <code>id</code> usado para:</li> <li>el texto</li> <li>el link</li> <li>la deduplicaci\u00f3n es exactamente el mismo</li> <li>El link debe ser: https://t.me// <p>yaml Copiar c\u00f3digo - El texto enviado debe provenir del mismo objeto que gener\u00f3 el link</p> <p>Si aparece cualquier inconsistencia: - Auditar Split / Set / Variables - Auditar entity usada en la API - Auditar l\u00f3gica de offsets, orden o cache en Telethon</p> <p>El sistema debe poder explicar por qu\u00e9 cada mensaje enviado corresponde exactamente a ese link.</p>"},{"location":"telegram-republisher-spec/#problemas-detectados-en-produccion","title":"Problemas detectados en producci\u00f3n","text":""},{"location":"telegram-republisher-spec/#1-mensajes-incorrectos","title":"\u274c 1. Mensajes incorrectos","text":"<ul> <li>El texto publicado no coincide con el mensaje real del link</li> <li>El link apunta a un post diferente</li> </ul> <p>\ud83d\udc49 Esto es un bug cr\u00edtico y tiene prioridad m\u00e1xima.</p>"},{"location":"telegram-republisher-spec/#2-imagenes-no-clonadas","title":"\u274c 2. Im\u00e1genes NO clonadas","text":"<ul> <li>Telethon devuelve <code>MessageMediaPhoto</code></li> <li>No existe URL p\u00fablica oficial</li> <li>Enviar texto + link NO genera preview</li> <li>Manualmente s\u00ed</li> </ul>"},{"location":"telegram-republisher-spec/#3-api-telethon-posiblemente-incompleta","title":"\u274c 3. API Telethon posiblemente incompleta","text":"<p>La API creci\u00f3 sin dise\u00f1o previo.</p> <p>Posibles carencias: - Manejo incorrecto de: - <code>entity</code> - <code>chat_id</code> vs <code>channel_id</code> - No tratamiento de: - \u00e1lbumes (<code>grouped_id</code>) - media compleja - Orden incorrecto de mensajes</p> <p>\ud83d\udc49 Se permite modificar la API.</p>"},{"location":"telegram-republisher-spec/#definicion-de-clonar-imagen","title":"Definici\u00f3n de \u201cclonar imagen\u201d","text":"<p>M\u00ednimo viable:</p> <ul> <li>Si el mensaje tiene 1 foto:</li> <li>Enviar esa foto al canal destino</li> <li>Usar la traducci\u00f3n como caption</li> </ul> <p>Opcional: - Si es \u00e1lbum (<code>grouped_id</code>): - Enviar solo la primera imagen - O todas si es trivial</p>"},{"location":"telegram-republisher-spec/#mision-orden-de-prioridad","title":"Misi\u00f3n (orden de prioridad)","text":""},{"location":"telegram-republisher-spec/#1-auditoria-total","title":"1\ufe0f\u20e3 Auditor\u00eda total","text":"<ul> <li>Workflow n8n</li> <li>API Telethon</li> <li>Construcci\u00f3n de links</li> <li>IDs reales de Telegram</li> <li>Inputs al AI Agent</li> </ul>"},{"location":"telegram-republisher-spec/#2-duplicar-workflow","title":"2\ufe0f\u20e3 Duplicar workflow","text":"<p>Trabajar SOLO sobre la copia.</p> <p>Nombre sugerido: \ud83e\uddea Telegram Translation + Republisher (Image + Audit)</p>"},{"location":"telegram-republisher-spec/#3-logica-funcional-final","title":"3\ufe0f\u20e3 L\u00f3gica funcional final","text":"<p>Para cada mensaje:</p>"},{"location":"telegram-republisher-spec/#a-publicidad-pura","title":"A. Publicidad pura","text":"<p>\ud83d\udc49 NO hacer nada</p>"},{"location":"telegram-republisher-spec/#b-mixto","title":"B. Mixto","text":"<p>\ud83d\udc49 Traducir solo la parte informativa \ud83d\udc49 Eliminar completamente la parte promocional</p>"},{"location":"telegram-republisher-spec/#c-informativo","title":"C. Informativo","text":"<p>\ud83d\udc49 Traducir fielmente, sin resumir</p>"},{"location":"telegram-republisher-spec/#4-publicacion","title":"4\ufe0f\u20e3 Publicaci\u00f3n","text":"<p>Enviar al canal destino:</p> <ul> <li>Texto traducido</li> <li>Link al original</li> <li>Imagen original (si existe y es viable)</li> </ul>"},{"location":"telegram-republisher-spec/#5-clonado-de-imagenes-critico","title":"5\ufe0f\u20e3 Clonado de im\u00e1genes (CR\u00cdTICO)","text":"<p>Investigar con el stack actual:</p> <ul> <li>Descargar imagen v\u00eda Telethon</li> <li>Servirla desde la API como binary</li> <li>Consumirla desde n8n (<code>Download: true</code>)</li> <li>Enviarla v\u00eda <code>Telegram Send Photo</code></li> </ul> <p>\u2757 Si NO es viable: - DETENERSE - Explicar exactamente: - Qu\u00e9 lo impide - Por qu\u00e9 - Qu\u00e9 alternativas existen:   - ForwardMessage   - CopyMessage   - User account   - Bot + user h\u00edbrido   - Storage intermedio   - Aceptar solo texto + link</p> <p>\u26a0\ufe0f No inventar soluciones irreales.</p>"},{"location":"telegram-republisher-spec/#edge-cases-obligatorios","title":"Edge cases obligatorios","text":"<ul> <li>Mensajes vac\u00edos</li> <li>Mensajes editados</li> <li>\u00c1lbumes (<code>grouped_id</code>)</li> <li>Videos / documentos</li> <li>Captions largas (l\u00edmite Telegram)</li> <li>Rate limits</li> <li>Fallos de descarga de media</li> <li>Fallos al enviar imagen</li> <li>Dedupe tras reinicio de n8n</li> <li>Mensajes reenviados (<code>forwarded</code>)</li> </ul>"},{"location":"telegram-republisher-spec/#reglas","title":"Reglas","text":"<ul> <li>Usar MCP de n8n</li> <li>No scraping HTML de <code>t.me</code></li> <li>No asumir viabilidad sin verificar en Telethon</li> <li>Documentar decisiones t\u00e9cnicas</li> <li>Priorizar robustez a workarounds fr\u00e1giles</li> </ul>"},{"location":"telegram-republisher-spec/#resultado-esperado","title":"Resultado esperado","text":""},{"location":"telegram-republisher-spec/#estado-a-solucion-completa","title":"\u2705 Estado A \u2013 Soluci\u00f3n completa","text":"<ul> <li>Mensajes correctos</li> <li>Texto fiel</li> <li>Imagen clonada</li> <li>Workflow estable</li> </ul>"},{"location":"telegram-republisher-spec/#estado-b-bloqueo-justificado","title":"\u274c Estado B \u2013 Bloqueo justificado","text":"<ul> <li>Explicaci\u00f3n clara del bloqueo</li> <li>Qu\u00e9 parte del stack lo impide</li> <li>Alternativas t\u00e9cnicas reales</li> </ul>"},{"location":"telegram-republisher-spec/#nota-final","title":"Nota final","text":"<p>Este sistema es a largo plazo.</p> <p>Prefiero: - Una limitaci\u00f3n bien explicada antes que - Una soluci\u00f3n fr\u00e1gil o falsa.</p>"}]}